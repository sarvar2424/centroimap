import React, { useEffect, useMemo, useState } from "react";

// === Minimal, geometric SVG icons ===
const GIcon = {
  Table: () => (
    <svg viewBox="0 0 24 24" className="w-8 h-8" aria-hidden>
      <rect x="3" y="5" width="18" height="14" rx="3" fill="currentColor" opacity="0.12"/>
      <path d="M3 10h18M12 5v14" stroke="currentColor" strokeWidth="1.4"/>
    </svg>
  ),
  Money: () => (
    <svg viewBox="0 0 24 24" className="w-8 h-8" aria-hidden>
      <rect x="3" y="6" width="18" height="12" rx="2" fill="currentColor" opacity="0.08"/>
      <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="1.4" fill="none"/>
    </svg>
  ),
  Org: () => (
    <svg viewBox="0 0 24 24" className="w-8 h-8" aria-hidden>
      <circle cx="12" cy="5" r="2.4" fill="currentColor" opacity="0.2"/>
      <path d="M12 7.8v4.2m0 0H6m6 0h6" stroke="currentColor" strokeWidth="1.4" strokeLinecap="round"/>
      <circle cx="6" cy="19" r="2.4" fill="currentColor" opacity="0.2"/>
      <circle cx="18" cy="19" r="2.4" fill="currentColor" opacity="0.2"/>
    </svg>
  ),
  Pie: () => (
    <svg viewBox="0 0 24 24" className="w-8 h-8" aria-hidden>
      <circle cx="12" cy="12" r="9" fill="currentColor" opacity="0.12"/>
      <path d="M12 3a9 9 0 019 9h-9V3z" fill="currentColor"/>
    </svg>
  ),
  Print: () => (
    <svg viewBox="0 0 24 24" className="w-5 h-5" aria-hidden>
      <path d="M6 9V4h12v5M6 14h12v6H6z" stroke="currentColor" strokeWidth="1.4" fill="none"/>
      <rect x="3" y="9" width="18" height="7" rx="2" fill="currentColor" opacity="0.1"/>
    </svg>
  )
};

// === Data (derived from your spec) ===
function buildData(lang: 'RU'|'UZ') {
  const t = lang === 'RU' ? {
    title: 'Shafran Group — Структура и зарплаты',
    subtitle: 'HQ, курьеры, розница · таблицы и итоги',
    actions: { printOn: 'Печать: ВКЛ', printOff: 'Печать: ВЫКЛ', ru: 'RU', uz: 'UZ' },
    sections: {
      org: { title: '1) Штат и иерархия (сводно)' },
      hq: { title: '2) Центральный офис (HQ) — состав и ставки' },
      cour: { title: '3) Курьерский пул' },
      retail: { title: '4) Розничные команды по точкам' },
      totals: { title: '5) Итого ФОТ (ежемесячно)' },
      opex: { title: '6) Прочие ежемесячные расходы (без COGS/налогов)' },
      grand: { title: '7) Общая модель расходов/мес' }
    },
    table: {
      role: 'Роль', fte: 'FTE', rate: 'Ставка, $/мес', subtotal: 'Субтотал, $/мес', note: 'Примечание',
      point: 'Точка', people: 'Кол-во', wage: 'Ставка $', sum: 'Сумма $'
    },
    notes: {
      covered: 'Покрывается владельцем/COO, без отдельной ставки',
      hqSum: 'ФОТ HQ по спецификации',
      excl: '*Без закупочной стоимости товара и налогов'
    },
    labels: { hqTotal: 'Итого HQ', courTotal: 'Итого курьеры', retailTotal: 'Итого розница', payrollTotal: 'ИТОГО ФОТ', expenses: 'Итого прочие расходы', grandTotal: 'ИТОГО (ФОТ + прочие)' }
  } : {
    title: 'Shafran Group — Tuzilma va ish haqi',
    subtitle: 'HQ, kuryerlar, chakana · jadvallar va yakunlar',
    actions: { printOn: 'Chop: YOQILGAN', printOff: 'Chop: O‘CHIRILGAN', ru: 'RU', uz: 'UZ' },
    sections: {
      org: { title: '1) Shtat va ierarxiya (umumiy)' },
      hq: { title: '2) Markaziy ofis (HQ) — tarkib va stavkalar' },
      cour: { title: '3) Kuryerlar pooli' },
      retail: { title: '4) Chakana jamoalar nuqtalar bo‘yicha' },
      totals: { title: '5) FOT jami (oyiga)' },
      opex: { title: '6) Boshqa oylik xarajatlar (COGS/soliqsiz)' },
      grand: { title: '7) Umumiy xarajat modeli/oy' }
    },
    table: {
      role: 'Rol', fte: 'FTE', rate: 'Stavka, $/oy', subtotal: 'Sub‑jami, $/oy', note: 'Izoh',
      point: 'Nuqta', people: 'Soni', wage: 'Stavka $', sum: 'Jami $'
    },
    notes: {
      covered: 'Egası/COO qoplaydi, alohida stavka yo‘q',
      hqSum: 'HQ FOT (spetsifikatsiya bo‘yicha)',
      excl: '*Tovar tannarxi (COGS) va soliqlarsiz'
    },
    labels: { hqTotal: 'HQ jami', courTotal: 'Kuryerlar jami', retailTotal: 'Chakana jami', payrollTotal: 'FOT JAMI', expenses: 'Boshqa xarajatlar jami', grandTotal: 'JAMI (FOT + boshqa)' }
  };

  // HQ roles — show ranges as text; total from spec
  const hqRows = [
    { role: 'COO (Операционный директор)', fte: 1, rateText: '$1,500–3,000' },
    { role: 'Area Supervisor', fte: 1, rateText: '$1,000–2,000' },
    { role: 'Wholesale Manager', fte: 0, rateText: '—', note: t.notes.covered },
    { role: 'Procurement Manager', fte: 0, rateText: '—', note: t.notes.covered },
    { role: 'Storekeeper / Кладовщик', fte: 1, rateText: '$500–1,000' },
    { role: 'IT/Мijozlar bazasi (рассылки) + Disp.', fte: 1, rateText: '$1,000–1,500' },
    { role: 'Финансы Controller / Главбух', fte: 1, rateText: '$1,000' },
    { role: 'HR Generalist + Office Admin', fte: 1, rateText: '$600–1,000' },
    { role: 'Head of Marketing', fte: 1, rateText: '$1,500' },
    { role: 'Performance Marketer', fte: 1, rateText: '$1,000' },
    { role: 'SMM Manager', fte: 1, rateText: '$700' },
    { role: 'Retention/Рассылки Manager', fte: 1, rateText: '$800' },
    { role: 'Videographer', fte: 1, rateText: '$900' },
    { role: 'Photographer', fte: 1, rateText: '$800' },
    { role: 'Video Editor / Motion', fte: 1, rateText: '$900' },
    { role: 'Designer', fte: 1, rateText: '$700' },
    { role: 'Copywriter / Community', fte: 1, rateText: '$600' },
  ];

  // We keep official HQ total from spec
  const hqTotal = 14700;

  // Couriers (exact)
  const couriers = { fte: 2, rate: 600, total: 2 * 600 };

  // Retail teams (exact)
  const retailRows = [
    { point: 'Shafran C5 — Парфюм', people: 2, wage: 900 },
    { point: 'Shafran C5 — Косметика', people: 2, wage: 700 },
    { point: 'O‘rikzor', people: 3, wage: 900 },
    { point: 'Stylord', people: 2, wage: 900 },
  ];
  const retailTotal = retailRows.reduce((s, r) => s + r.people * r.wage, 0);

  // Other monthly expenses (from spec)
  const otherExpenses = [
    { name: lang==='RU'?'Аренда+коммунальные (точки)':'Ijara+kommunal (nuqtalar)', amount: 7700 },
    { name: lang==='RU'?'Уборка':'Tozalash', amount: 300 },
    { name: 'Media (Meta/Google/Telegram)', amount: 7000 },
    { name: lang==='RU'?'Инфлюенсеры':'Influencerlar', amount: 3000 },
    { name: lang==='RU'?'HQ офис (оценка)':'HQ ofis (taxmin)', amount: 1500 },
    { name: lang==='RU'?'ПО/сервисы':'Dastur/servislar', amount: 500 },
  ];
  const otherTotal = otherExpenses.reduce((s, e) => s + e.amount, 0);

  const payrollTotal = hqTotal + couriers.total + retailTotal;
  const grandTotal = payrollTotal + otherTotal;

  return { t, hqRows, hqTotal, couriers, retailRows, retailTotal, otherExpenses, otherTotal, payrollTotal, grandTotal };
}

export default function ShafranPayrollSlides() {
  const [lang, setLang] = useState<'RU'|'UZ'>('RU');
  const [i, setI] = useState(0);
  const [printMode, setPrintMode] = useState(false);
  const data = useMemo(() => buildData(lang), [lang]);

  const slides = useMemo(() => ([
    {
      icon: <GIcon.Org/>,
      title: data.t.title,
      subtitle: data.t.subtitle,
      body: (
        <div className="space-y-4">
          <p className="opacity-90">{lang==='RU' ? 'Полная сводка по составу, FTE и ежемесячным выплатам.' : 'Shtat, FTE va oylik to‘lovlar bo‘yicha to‘liq yig‘indi.'}</p>
          <div className="grid md:grid-cols-3 gap-4">
            <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-80">{lang==='RU'?'ФОТ HQ':'HQ FOT'}</div><div className="text-2xl font-semibold">${data.hqTotal.toLocaleString()}</div></div>
            <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-80">{lang==='RU'?'ФОТ розницы':'Chakana FOT'}</div><div className="text-2xl font-semibold">${data.retailTotal.toLocaleString()}</div></div>
            <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-80">{lang==='RU'?'Курьеры':'Kuryerlar'}</div><div className="text-2xl font-semibold">${data.couriers.total.toLocaleString()}</div></div>
          </div>
        </div>
      )
    },
    {
      icon: <GIcon.Table/>,
      title: data.t.sections.hq.title,
      subtitle: '',
      body: (
        <div className="overflow-x-auto">
          <table className="w-full text-sm border-separate border-spacing-y-2">
            <thead>
              <tr className="text-left text-xs uppercase tracking-wide text-white/70">
                <th className="px-3 py-2 rounded-l-xl bg-white/10">{data.t.table.role}</th>
                <th className="px-3 py-2 bg-white/10">{data.t.table.fte}</th>
                <th className="px-3 py-2 bg-white/10">{data.t.table.rate}</th>
                <th className="px-3 py-2 bg-white/10">{data.t.table.note}</th>
                <th className="px-3 py-2 rounded-r-xl bg-white/10 text-right">{data.t.table.subtotal}</th>
              </tr>
            </thead>
            <tbody>
              {data.hqRows.map((r, idx) => (
                <tr key={idx} className="bg-white/5">
                  <td className="px-3 py-2 rounded-l-xl">{r.role}</td>
                  <td className="px-3 py-2">{r.fte}</td>
                  <td className="px-3 py-2 whitespace-nowrap">{r.rateText}</td>
                  <td className="px-3 py-2 opacity-80">{r.note||'—'}</td>
                  <td className="px-3 py-2 rounded-r-xl text-right">—</td>
                </tr>
              ))}
              <tr className="bg-white/10 font-semibold">
                <td className="px-3 py-2 rounded-l-xl" colSpan={4}>{data.t.notes.hqSum}</td>
                <td className="px-3 py-2 rounded-r-xl text-right">${data.hqTotal.toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
        </div>
      )
    },
    {
      icon: <GIcon.Table/>,
      title: data.t.sections.cour.title,
      subtitle: '',
      body: (
        <div className="grid md:grid-cols-3 gap-4">
          <div className="rounded-2xl bg-white/5 p-4">
            <div className="text-sm opacity-70">FTE</div>
            <div className="text-2xl font-semibold">{data.couriers.fte}</div>
          </div>
          <div className="rounded-2xl bg-white/5 p-4">
            <div className="text-sm opacity-70">{data.t.table.rate}</div>
            <div className="text-2xl font-semibold">${data.couriers.rate}</div>
          </div>
          <div className="rounded-2xl bg-white/5 p-4">
            <div className="text-sm opacity-70">{lang==='RU'?'Сумма':'Jami'}</div>
            <div className="text-2xl font-semibold">${data.couriers.total}</div>
          </div>
        </div>
      )
    },
    {
      icon: <GIcon.Table/>,
      title: data.t.sections.retail.title,
      subtitle: '',
      body: (
        <div className="overflow-x-auto">
          <table className="w-full text-sm border-separate border-spacing-y-2">
            <thead>
              <tr className="text-left text-xs uppercase tracking-wide text-white/70">
                <th className="px-3 py-2 rounded-l-xl bg-white/10">{data.t.table.point}</th>
                <th className="px-3 py-2 bg-white/10">{data.t.table.people}</th>
                <th className="px-3 py-2 bg-white/10">{data.t.table.wage}</th>
                <th className="px-3 py-2 rounded-r-xl bg-white/10 text-right">{data.t.table.sum}</th>
              </tr>
            </thead>
            <tbody>
              {data.retailRows.map((r, idx) => (
                <tr key={idx} className="bg-white/5">
                  <td className="px-3 py-2 rounded-l-xl">{r.point}</td>
                  <td className="px-3 py-2">{r.people}</td>
                  <td className="px-3 py-2">${r.wage}</td>
                  <td className="px-3 py-2 rounded-r-xl text-right">${(r.people*r.wage).toLocaleString()}</td>
                </tr>
              ))}
              <tr className="bg-white/10 font-semibold">
                <td className="px-3 py-2 rounded-l-xl" colSpan={3}>{lang==='RU'?'Итого розница':'Chakana jami'}</td>
                <td className="px-3 py-2 rounded-r-xl text-right">${data.retailTotal.toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
        </div>
      )
    },
    {
      icon: <GIcon.Money/>,
      title: data.t.sections.totals.title,
      subtitle: '',
      body: (
        <div className="grid md:grid-cols-3 gap-4">
          <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-70">{data.t.labels.hqTotal}</div><div className="text-2xl font-semibold">${data.hqTotal.toLocaleString()}</div></div>
          <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-70">{data.t.labels.retailTotal}</div><div className="text-2xl font-semibold">${data.retailTotal.toLocaleString()}</div></div>
          <div className="rounded-2xl bg-white/5 p-4"><div className="text-sm opacity-70">{data.t.labels.courTotal}</div><div className="text-2xl font-semibold">${data.couriers.total.toLocaleString()}</div></div>
          <div className="md:col-span-3 rounded-2xl bg-white/10 p-4 flex items-center justify-between">
            <div className="text-sm opacity-80">{data.t.labels.payrollTotal}</div>
            <div className="text-3xl font-semibold">${data.payrollTotal.toLocaleString()}</div>
          </div>
        </div>
      )
    },
    {
      icon: <GIcon.Pie/>,
      title: data.t.sections.opex.title,
      subtitle: '',
      body: (
        <div className="overflow-x-auto">
          <table className="w-full text-sm border-separate border-spacing-y-2">
            <thead>
              <tr className="text-left text-xs uppercase tracking-wide text-white/70">
                <th className="px-3 py-2 rounded-l-xl bg-white/10">{lang==='RU'?'Статья':'Modda'}</th>
                <th className="px-3 py-2 rounded-r-xl bg-white/10 text-right">{lang==='RU'?'Сумма, $/мес':'Miqdor, $/oy'}</th>
              </tr>
            </thead>
            <tbody>
              {data.otherExpenses.map((e, idx) => (
                <tr key={idx} className="bg-white/5">
                  <td className="px-3 py-2 rounded-l-xl">{e.name}</td>
                  <td className="px-3 py-2 rounded-r-xl text-right">${e.amount.toLocaleString()}</td>
                </tr>
              ))}
              <tr className="bg-white/10 font-semibold">
                <td className="px-3 py-2 rounded-l-xl">{data.t.labels.expenses}</td>
                <td className="px-3 py-2 rounded-r-xl text-right">${data.otherTotal.toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
          <p className="text-xs opacity-70 mt-2">{data.t.notes.excl}</p>
        </div>
      )
    },
    {
      icon: <GIcon.Money/>,
      title: data.t.sections.grand.title,
      subtitle: '',
      body: (
        <div className="grid md:grid-cols-2 gap-4">
          <div className="rounded-2xl bg-white/5 p-4">
            <div className="text-sm opacity-70">{data.t.labels.payrollTotal}</div>
            <div className="text-2xl font-semibold">${data.payrollTotal.toLocaleString()}</div>
          </div>
          <div className="rounded-2xl bg-white/5 p-4">
            <div className="text-sm opacity-70">{data.t.labels.expenses}</div>
            <div className="text-2xl font-semibold">${data.otherTotal.toLocaleString()}</div>
          </div>
          <div className="md:col-span-2 rounded-2xl bg-white/10 p-5 flex items-center justify-between">
            <div className="text-base opacity-80">{data.t.labels.grandTotal}</div>
            <div className="text-3xl font-semibold">${data.grandTotal.toLocaleString()}</div>
          </div>
        </div>
      )
    }
  ]), [data, lang]);

  const total = slides.length;

  useEffect(() => {
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') setI((x) => Math.min(x + 1, total - 1));
      if (e.key === 'ArrowLeft') setI((x) => Math.max(x - 1, 0));
      if (e.key.toLowerCase() === 'p') setPrintMode((v) => !v);
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [total]);

  return (
    <div className="min-h-screen w-full bg-[radial-gradient(60%_60%_at_20%_20%,rgba(255,255,255,0.06),transparent),radial-gradient(40%_40%_at_80%_20%,rgba(255,255,255,0.04),transparent)] bg-zinc-950 text-zinc-50">
      <div className="mx-auto max-w-6xl px-6 py-8">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-xl bg-white/10">
              <GIcon.Table/>
            </div>
            <div>
              <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">{slides[i].title}</h1>
              <p className="text-sm opacity-80">{slides[i].subtitle}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="flex rounded-xl overflow-hidden border border-white/15">
              <button className={`px-3 py-2 text-sm ${lang==='RU'?'bg-white/20':'bg-white/5 hover:bg-white/10'}`} onClick={() => setLang('RU')}>RU</button>
              <button className={`px-3 py-2 text-sm ${lang==='UZ'?'bg-white/20':'bg-white/5 hover:bg-white/10'}`} onClick={() => setLang('UZ')}>UZ</button>
            </div>
            <button className="p-2 rounded-xl bg-white/10 hover:bg-white/20" onClick={() => setI((x)=>Math.max(x-1,0))} aria-label="Prev">
              <svg viewBox="0 0 24 24" className="w-5 h-5"><path d="M15 6l-6 6 6 6" stroke="currentColor" strokeWidth="1.6" fill="none" strokeLinecap="round"/></svg>
            </button>
            <button className="p-2 rounded-xl bg-white/10 hover:bg-white/20" onClick={() => setI((x)=>Math.min(x+1,total-1))} aria-label="Next">
              <svg viewBox="0 0 24 24" className="w-5 h-5"><path d="M9 6l6 6-6 6" stroke="currentColor" strokeWidth="1.6" fill="none" strokeLinecap="round"/></svg>
            </button>
            <button className={`px-3 py-2 rounded-xl border border-white/15 ${printMode? 'bg-white/20':'bg-white/10'}`} onClick={()=>setPrintMode(v=>!v)} aria-label="Toggle print">
              <span className="inline-flex items-center gap-2"><GIcon.Print/>{printMode?data.t.actions.printOn:data.t.actions.printOff}</span>
            </button>
          </div>
        </div>

        {/* Progress */}
        <div className="h-2 rounded-full bg-white/10 overflow-hidden mb-6">
          <div className="h-full bg-white/60" style={{ width: `${((i+1)/total)*100}%` }} />
        </div>

        {/* Slide */}
        <div className="rounded-3xl bg-white/5 border border-white/10 p-6 md:p-8 shadow-2xl">
          <div className="flex items-start gap-4 mb-4">
            <div className="p-2 rounded-xl bg-white/10">{slides[i].icon}</div>
            <div className="flex-1">
              <h2 className="text-xl md:text-2xl font-semibold mb-1">{slides[i].title}</h2>
              {slides[i].subtitle && <p className="text-sm opacity-80">{slides[i].subtitle}</p>}
            </div>
          </div>
          {slides[i].body}
        </div>

        <div className="flex items-center justify-between mt-6 text-xs opacity-80">
          <span>{lang==='RU'?'Слайд':'Slayd'} {i+1} / {total}</span>
          <span>{lang==='RU'?'←/→ — навигация · P — печать · Cmd/Ctrl+P — PDF':'←/→ — navigatsiya · P — chop · Cmd/Ctrl+P — PDF'}</span>
        </div>
      </div>

      {/* Print mode: all slides */}
      {printMode && (
        <div className="mx-auto max-w-6xl px-6 pb-16">
          <h3 className="text-lg font-semibold mt-10 mb-4">{lang==='RU'?'Версия для печати':'Chop uchun versiya'}</h3>
          <div className="space-y-6">
            {slides.map((s, idx) => (
              <div key={idx} className="rounded-3xl bg-white/5 border border-white/10 p-6">
                <div className="flex items-start gap-3 mb-3">
                  <div className="p-2 rounded-xl bg-white/10">{s.icon}</div>
                  <div>
                    <h4 className="text-lg font-semibold">{s.title}</h4>
                    {s.subtitle && <p className="text-sm opacity-80">{s.subtitle}</p>}
                  </div>
                </div>
                {s.body}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
